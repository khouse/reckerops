events {
    worker_connections  1024;
}

http {

    # Mimetypes
    #
    types {
        text/html html htm shtml;
        text/css css;
        text/xml xml rss;
        image/gif gif;
        image/jpeg jpeg jpg;
        application/x-javascript js;
        text/plain txt;
        text/x-component htc;
        text/mathml mml;
        image/png png;
        image/x-icon ico;
        image/x-jng jng;
        image/vnd.wap.wbmp wbmp;
        application/java-archive jar war ear;
        application/mac-binhex40 hqx;
        application/pdf pdf;
        application/x-cocoa cco;
        application/x-java-archive-diff jardiff;
        application/x-java-jnlp-file jnlp;
        application/x-makeself run;
        application/x-perl pl pm;
        application/x-pilot prc pdb;
        application/x-rar-compressed rar;
        application/x-redhat-package-manager rpm;
        application/x-sea sea;
        application/x-shockwave-flash swf;
        application/x-stuffit sit;
        application/x-tcl tcl tk;
        application/x-x509-ca-cert der pem crt;
        application/x-xpinstall xpi;
        application/zip zip;
        application/octet-stream deb;
        application/octet-stream bin exe dll;
        application/octet-stream dmg;
        application/octet-stream eot;
        application/octet-stream iso img;
        application/octet-stream msi msp msm;
        audio/mpeg mp3;
        audio/x-realaudio ra;
        video/mpeg mpeg mpg;
        video/quicktime mov;
        video/x-flv flv;
        video/x-msvideo avi;
        video/x-ms-wmv wmv;
        video/x-ms-asf asx asf;
        video/x-mng mng;
    }

    # Proxy Settings
    #
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    client_max_body_size 10m;
    client_body_buffer_size 128k;
    proxy_connect_timeout 90;
    proxy_send_timeout 90;
    proxy_read_timeout 90;
    proxy_buffers 32 4k;

    index index.html index.htm index.php;

    # Default Server
    #
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;
        root {{ webroot }}default;
    }
    {% for domain, upstream in hosts.iteritems() %}
    # HTTP Redirect & ACME Challenge for {{ domain }}
    #
    server {
        listen 0.0.0.0:80;
        listen [::]:80;
        server_name {{ domain }};
        root {{ webroot }}default;

        location ~ /.well-known {
            allow all;
            break;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS for {{ domain }}
    #
    server {
        listen 0.0.0.0:443 ssl;
        listen [::]:443 ssl;
        server_name {{ domain }};

        # Uncomment these once certs have been created
        # ssl_certificate /etc/letsencrypt/live/{{ domain }}/fullchain.pem;
        # ssl_certificate_key /etc/letsencrypt/live/{{ domain }}/privkey.pem;

        location / {
            proxy_pass http://{{ upstream }};
        }
    }
    {% endfor %}
}
